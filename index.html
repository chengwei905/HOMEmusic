<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>GitHub Pages 音樂播放器</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f9f9f9; }
    h1, h2 { margin-top: 1em; }
    #loading { font-style: italic; color: #666; }
    select { padding: 0.5em; font-size: 1em; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>🎵 GitHub Pages 音樂播放器</h1>
  <audio controls></audio>
  <div id="loading">正在載入音樂清單...</div>

  <h2>播放清單</h2>
  <select id="playlist"></select>

  <script>
    const getMusicBase = () => {
      const basePath = window.location.pathname.replace(/\/[^\/]*$/, '/');
      return basePath + 'music/';
    };

    const fetchPlaylistJson = async (base) => {
      try {
        const res = await fetch(`${base}playlist.json`);
        if (!res.ok) throw new Error('playlist.json not found');
        return await res.json();
      } catch (err) {
        return null;
      }
    };

    const fetchAutoIndex = async (base) => {
      try {
        const res = await fetch(base);
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        return [...doc.querySelectorAll('a')]
          .map(a => a.getAttribute('href'))
          .filter(href => href && href.endsWith('.mp3'))
          .map(href => base + href);
      } catch (err) {
        return [];
      }
    };

    const loadPlaylist = async () => {
      const base = getMusicBase();
      const jsonList = await fetchPlaylistJson(base);
      if (jsonList && jsonList.length) return jsonList.map(file => base + file);

      const autoList = await fetchAutoIndex(base);
      if (autoList.length) return autoList;

      return [];
    };

    const renderPlaylistUI = (list) => {
      const select = document.getElementById('playlist');
      select.innerHTML = '';

      list.forEach((url, i) => {
        const option = document.createElement('option');
        option.value = url;
        option.textContent = url.split('/').pop();
        select.appendChild(option);
      });

      select.onchange = () => {
        const audio = document.querySelector('audio');
        audio.src = select.value;
        audio.play();
      };
    };

    const initPlayer = async () => {
      const base = getMusicBase();
      const playlist = await loadPlaylist();
      document.getElementById('loading').style.display = 'none';

      if (!playlist.length) {
        alert('找不到預設音樂，請確認 music 資料夾是否存在音訊檔案');
        return;
      }

      const audio = document.querySelector('audio');
      audio.src = playlist[0];
      audio.play().catch(() => console.log('Autoplay blocked'));

      renderPlaylistUI(playlist);
    };

    initPlayer();
  </script>
</body>
</html>

